<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>主页</title>
  <script src="/static/js/jquery-3.6.0.min.js"></script>
  <script src="/static/js/auth-guard.js"></script>
  <script src="/static/js/articles.js"></script>
  <style>
    html,body{height:100%;margin:0}
    body{font-family: Arial, Helvetica, sans-serif;margin:0;height:100vh;background-image: url('/static/img/bg.jpg');background-size: cover;background-position: center;background-repeat: no-repeat}
    .card{width:100%;height:100%;background:rgba(255,255,255,0.95);padding:24px;border-radius:0;box-shadow:none;box-sizing:border-box}
    /* ensure the articles container can display 10 rows without internal scroll (10 * row-height) */
    #articles{min-height:calc(56px * 10);overflow:visible;max-height:none}

    /* layout */
    .content-wrapper{display:flex;gap:16px}
    .mainContent{flex:1;min-width:0}
    .sidebar{width:220px;flex-shrink:0}
    .nav-sidebar{width:180px;flex-shrink:0;background:#f5f5f5;border-radius:8px;padding:16px}
    .nav-sidebar h4{margin:0 0 12px 0;color:#333}
    .nav-sidebar .nav-item{display:block;width:100%;padding:10px 12px;border:none;border-radius:6px;background:transparent;color:#333;text-align:left;cursor:pointer;margin-bottom:6px;transition:all 0.2s}
    .nav-sidebar .nav-item:hover{background:#e0e0e0}
    .nav-sidebar .nav-item.active{background:#1976d2;color:#fff}
    .nav-sidebar .nav-dropdown summary.nav-item{cursor:pointer;list-style:none}
    .nav-sidebar .nav-dropdown summary.nav-item::-webkit-details-marker{display:none}
    .nav-sidebar .nav-subitem{display:block;width:100%;padding:8px 12px 8px 24px;border:none;border-radius:6px;background:transparent;color:#333;text-align:left;cursor:pointer;margin-bottom:4px;transition:all 0.2s;font-size:14px}
    .nav-sidebar .nav-subitem:hover{background:#e0e0e0}
    .nav-sidebar .nav-subitem.active{background:#1976d2;color:#fff}
    .sidebar h4{margin:0 0 8px 0}
    #labelList{display:flex;flex-wrap:wrap}

    /* tag button styling: light green background, black text, smaller and lighter than title */
    .tagBtn{background:#e6f4ea;color:#111;border:none;padding:4px 8px;border-radius:6px;font-size:12px;opacity:0.95;cursor:pointer;margin-right:6px;margin-bottom:6px}
    .tagBtn:hover{background:#d6eed8}
    .tagBtn:focus{outline:2px solid rgba(25,118,210,0.2);outline-offset:2px}
    /* label button (sidebar) active state */
    .labelBtn.active{background:#1976d2;color:#fff}

    /* article table */
    .articleTable{width:100%;border-collapse:collapse;font-size:14px;table-layout:fixed}
    .articleTable th{text-align:left;padding:10px;border-bottom:1px solid #eee;color:#333}
    .articleTable td{padding:10px;border-bottom:1px solid #f3f3f3;vertical-align:middle;overflow:hidden}
    .articleTable tbody tr{height:56px}
    .articleTable td{line-height:56px}
    .articleTable .titleCell{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:360px}
    .articleTable .tagsCell{max-width:320px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
    .articleTable .actionsCell{white-space:nowrap}
    .articleTable .tagsCell .tagBtn{display:inline-block;margin-right:6px}
    button{padding:10px 14px;border-radius:6px;border:none;background:#1976d2;color:#fff}
    
    /* pagination buttons */
    .page-btn{padding:6px 10px;border-radius:4px;border:1px solid #ddd;background:#fff;color:#333;cursor:pointer;font-size:14px}
    .page-btn:hover:not(:disabled){background:#f5f5f5}
    .page-btn:focus{outline:2px solid rgba(25,118,210,0.2);outline-offset:2px}
    #paginationControls span{margin:0 4px;color:#666}
  </style>
</head>
<body>
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div>
        <h2 id="welcome">文章管理系统</h2>
        <p id="info"></p>
      </div>
      <div style="display:flex;align-items:center;gap:16px">
        <div style="text-align:right">
          <div id="userInfo">欢迎，<span id="username">用户</span>
            <div id="loginInfo" style="font-size:12px;color:#666;margin-top:4px">您尚未登录</div>
          </div>
        </div>
        <button id="logout">退出登录</button>
      </div>
    </div>

    <hr />

    <div class="content-wrapper">
      <aside class="nav-sidebar">
        <h4>导航</h4>
        <button class="nav-item active" data-page="articles">文章</button>
        <details class="nav-dropdown">
          <summary class="nav-item">K8s 资源</summary>
          <button class="nav-subitem" data-page="deployments">Deployments</button>
          <button class="nav-subitem" data-page="daemonsets">DaemonSets</button>
          <button class="nav-subitem" data-page="statefulsets">StatefulSets</button>
          <button class="nav-subitem" data-page="jobs">Jobs</button>
          <button class="nav-subitem" data-page="cronjobs">CronJobs</button>
          <button class="nav-subitem" data-page="services">Services</button>
        </details>
        <button class="nav-item" data-page="about">关于</button>
        <button class="nav-item" data-page="contact">联系我们</button>
      </aside>

      <div class="mainContent">
        <!-- 文章标签页内容 -->
        <div id="articlesPage" style="display:flex;gap:16px">
          <div style="flex:1;min-width:0">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
              <h2>文章列表</h2>
              <button id="new">发布文章</button>
            </div>

            <div id="articles">
              <p>加载中...</p>
            </div>

            <div id="pager" style="margin-top:16px;display:flex;justify-content:center;gap:8px;align-items:center">
              <button id="prev" disabled>上一页</button>
              <span id="pageInfo">第 <span id="pageNum">1</span> 页</span>
              <div id="paginationControls" style="display:flex;gap:4px;align-items:center"></div>
              <button id="clearFilter" style="display:none;background:#f5f5f5;color:#333;border-radius:6px;padding:6px 8px;border:none;cursor:pointer">清除筛选</button>
              <button id="next" disabled>下一页</button>
            </div>
          </div>

          <aside class="sidebar">
            <h4>标签</h4>
            <div id="labelList">
              <button class="tagBtn labelBtn" data-tag="" aria-label="所有" tabindex="0">所有</button>
              <div id="labelsLoading" style="color:#666;margin-top:8px">加载标签中...</div>
            </div>
          </aside>
        </div>

        <!-- Deployments 页面 -->
        <div id="deploymentsPage" style="display:none">
          <h2>Deployments</h2>
          <iframe src="/static/deployments.html" style="width:100%;height:600px;border:none;"></iframe>
        </div>

        <!-- DaemonSets 页面 -->
        <div id="daemonsetsPage" style="display:none">
          <h2>DaemonSets</h2>
          <iframe src="/static/daemonsets.html" style="width:100%;height:600px;border:none;"></iframe>
        </div>

        <!-- StatefulSets 页面 -->
        <div id="statefulsetsPage" style="display:none">
          <h2>StatefulSets</h2>
          <iframe src="/static/statefulsets.html" style="width:100%;height:600px;border:none;"></iframe>
        </div>

        <!-- Jobs 页面 -->
        <div id="jobsPage" style="display:none">
          <h2>Jobs</h2>
          <iframe src="/static/jobs.html" style="width:100%;height:600px;border:none;"></iframe>
        </div>

        <!-- CronJobs 页面 -->
        <div id="cronjobsPage" style="display:none">
          <h2>CronJobs</h2>
          <iframe src="/static/cronjobs.html" style="width:100%;height:600px;border:none;"></iframe>
        </div>

        <!-- Services 页面 -->
        <div id="servicesPage" style="display:none">
          <h2>Services</h2>
          <iframe src="/static/services.html" style="width:100%;height:600px;border:none;"></iframe>
        </div>

        <!-- 关于标签页内容 -->
        <div id="aboutPage" style="display:none">
          <h2>关于我们</h2>
          <p>这是一个简单的文章管理系统，用于发布和管理新闻文章。</p>
        </div>

        <!-- 联系我们标签页内容 -->
        <div id="contactPage" style="display:none">
          <h2>联系我们</h2>
          <p>如有任何问题，请联系我们的管理员。管理员邮箱:gexin17812126257@163.com</p>
        </div>
      </div>
    </div>
  </div>

  <!-- modal for viewing/editing -->
  <div id="modal" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center">
    <div style="background:#fff;padding:16px;border-radius:8px;max-width:800px;width:90%;max-height:80%;overflow:auto">
      <h3 id="modalTitle"></h3>
      <div id="modalMeta" style="color:#666;font-size:13px;margin-bottom:8px"></div>
      <div id="modalBodyWrap"><div id="modalBody" style="white-space:pre-wrap;color:#333"></div></div>
      <div id="editFields" style="display:none">
        <label>标题</label>
        <input id="editTitle" type="text" style="width:100%;padding:8px;margin:6px 0" />
        <label>正文</label>
        <textarea id="editBody" rows="12" style="width:100%;padding:8px;margin:6px 0"></textarea>
        <label>标签（输入用逗号分隔，或从下面选择）</label>
        <input type="text" id="editTagInput" placeholder="例如: go,web,gin" style="width:100%;padding:8px;margin:6px 0;border:1px solid #ccc;border-radius:4px" />
        <div id="editExistingTags" style="margin:8px 0"></div>
      </div>
      <div style="text-align:right;margin-top:8px">
        <button id="modalCancel">关闭</button>
        <button id="modalSave" style="display:none;margin-left:8px">保存</button>
      </div>
    </div>
  </div>

  <script>
    function getToken(){ try{ var t = localStorage.getItem('token'); if(t) return t }catch(e){} var m=document.cookie.match(/(^|; )token=([^;]+)/); return m?decodeURIComponent(m[2]):null }

    function base64UrlDecode(str){ str = str.replace(/-/g, '+').replace(/_/g, '/'); while(str.length % 4) str += '='; try{ var bin = atob(str); var bytes = Array.prototype.map.call(bin, function(c){ return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2); }).join(''); return decodeURIComponent(bytes); }catch(e){ return null } }

    function parseJwtPayload(token){ if(!token) return null; var parts = token.split('.'); if(parts.length < 2) return null; var payload = base64UrlDecode(parts[1]); if(!payload) return null; try{ return JSON.parse(payload) }catch(e){ return null } }

    function formatTimeRemaining(seconds){ if(seconds <= 0) return '已过期'; var hours = Math.floor(seconds / 3600); var minutes = Math.floor((seconds % 3600) / 60); var secs = Math.floor(seconds % 60); return (hours > 0 ? hours + '小时' : '') + (minutes > 0 ? minutes + '分' : '') + secs + '秒' }

    function updateLoginCountdown(){ var token = getToken(); var payload = token ? parseJwtPayload(token) : null; if(payload && payload.exp){ var now = Math.floor(Date.now() / 1000); var remaining = payload.exp - now; if(remaining > 0){ $('#loginInfo').text('您已登录，剩余有效期：' + formatTimeRemaining(remaining)) } else { $('#loginInfo').text('登录已过期，请重新登录') } } else { $('#loginInfo').text('您尚未登录') } }

    $(function(){
      var token = getToken();
      var payload = token ? parseJwtPayload(token) : null;
      var user = payload && payload.sub ? payload.sub : '用户';
      $('#username').text(user);
      updateLoginCountdown();
      setInterval(updateLoginCountdown, 1000);

      $('#logout').on('click', function(){ $('#logout').prop('disabled', true).text('正在退出...'); $.ajax({ url: '/users/logout', method: 'POST', success: function(){ try{ localStorage.removeItem('token') }catch(e){} document.cookie = 'token=;max-age=0;path=/'; window.location.href = '/users/to_login'; }, error: function(){ try{ localStorage.removeItem('token') }catch(e){} document.cookie = 'token=;max-age=0;path=/'; window.location.href = '/users/to_login'; } }) })
      $('#new').on('click', function(){ window.location.href = '/static/new_article.html' })

      // 导航栏点击事件
      $('.nav-item, .nav-subitem').on('click', function(){ 
        var page = $(this).data('page'); 
        $('.nav-item, .nav-subitem').removeClass('active'); 
        $(this).addClass('active'); 
        $('.mainContent > div').hide(); 
        $('#' + page + 'Page').show(); 
        if(page === 'articles'){ 
          if(typeof loadArticles === 'function'){
            loadArticles();
          }
        } 
      });

      // 初始化文章相关功能
      initArticles(user);

      // 关闭模态框按钮
      $('#modalCancel').on('click', function(){ $('#modal').hide(); $('#editFields').hide(); $('#modalSave').hide(); });
    })
  </script>
</body>
</html>